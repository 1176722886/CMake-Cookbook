# 2.5 检测处理器指令集

**NOTE**:*此示例代码可以在 https://github.com/devcafe/cmake-cookbook/tree/v1.0/chap-02/recipe-05 中找到，包含C++、C和Fortran示例。该示例在CMake 3.10版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。*

本示例中，我们将讨论如何在CMake的帮助下检测主机处理器支持的指令集。这个功能是较新版本添加到CMake中的，需要CMake 3.10或更高版本。检测到的主机系统信息，可用于设置相应的编译器标志，或实现可选的源代码编译，或根据主机系统生成源代码。本示例中，我们的目标是检测主机系统信息，使用预处理器定义将其传递给C++源代码，并将信息打印到输出中。

## 如何实施

我们将使用CMake为平台填充`config.h`中的定义，并将示例源文件编译为可执行文件:

1. 首先，我们定义了最小的CMake版本、项目名称和项目语言:

   ```cmake
   cmake_minimum_required(VERSION 3.10 FATAL_ERROR)
   project(recipe-05 CXX)
   ```

2. 然后，定义目标可执行文件及其源文件，并包括目录:

   ```cmake
   add_executable(processor-info "")
   
   target_sources(processor-info
     PRIVATE
     	processor-info.cpp
     )
   
   target_include_directories(processor-info
     PRIVATE
    	  ${PROJECT_BINARY_DIR}
     )
   ```

3. 我们继续查询主机系统的信息，以获取一些关键字:

   ```cmake
   foreach(key
     IN ITEMS
       NUMBER_OF_LOGICAL_CORES
       NUMBER_OF_PHYSICAL_CORES
       TOTAL_VIRTUAL_MEMORY
       AVAILABLE_VIRTUAL_MEMORY
       TOTAL_PHYSICAL_MEMORY
       AVAILABLE_PHYSICAL_MEMORY
       IS_64BIT
       HAS_FPU
       HAS_MMX
       HAS_MMX_PLUS
       HAS_SSE
       HAS_SSE2
       HAS_SSE_FP
       HAS_SSE_MMX
       HAS_AMD_3DNOW
       HAS_AMD_3DNOW_PLUS
       HAS_IA64
       OS_NAME
       OS_RELEASE
       OS_VERSION
       OS_PLATFORM
     )
     cmake_host_system_information(RESULT _${key} QUERY ${key})
   endforeach()
   ```

4. 定义了相应的变量后，配置`config.h`:

   ```cmake
   configure_file(config.h.in config.h @ONLY)
   ```

5. 现在我们准备好配置、构建和测试项目:

   ```shell
   $ mkdir -p build
   $ cd build
   $ cmake ..
   $ cmake --build .
   $ ./processor-info
   
   Number of logical cores: 4
   Number of physical cores: 2
   Total virtual memory in megabytes: 15258
   Available virtual memory in megabytes: 14678
   Total physical memory in megabytes: 7858
   Available physical memory in megabytes: 4072
   Processor is 64Bit: 1
   Processor has floating point unit: 1
   Processor supports MMX instructions: 1
   Processor supports Ext. MMX instructions: 0
   Processor supports SSE instructions: 1
   Processor supports SSE2 instructions: 1
   Processor supports SSE FP instructions: 0
   Processor supports SSE MMX instructions: 0
   Processor supports 3DNow instructions: 0
   Processor supports 3DNow+ instructions: 0
   IA64 processor emulating x86 : 0
   OS name: Linux
   OS sub-type: 4.16.7-1-ARCH
   OS build ID: #1 SMP PREEMPT Wed May 2 21:12:36 UTC 2018
   OS platform: x86_64
   ```

6. 输出当然会随着处理器的不同而变化。

## 如何工作

`CMakeLists.txt`中的`foreach`循环会查询多个键值，并定义相应的变量。此示例的核心函数是`cmake_host_system_information`，它查询运行CMake的主机系统的系统信息。这个函数可以在一个函数调用中使用多个键来调用。不过本例中，我们对每个键使用了一个函数调用。然后，我们使用这些变量来配置`config.h`中的占位符，输入并生成`config.h`。此配置使用`configure_file`命令完成。最后，`config.h`包含在`processor-info.cpp`中，编译后，它将把值打印到屏幕上。我们将在第5章(配置时和构建时操作)和第6章(生成源代码)中重新讨论这种方法。

## 更多信息

对于更细粒度的处理器指令集检测，请考虑以下模块: https://github.com/VcDevel/Vc/blob/master/cmake/OptimizeForArchitecture.cmake 。有时候，构建代码的主机可能与运行代码的主机不一样。在计算集群中，登录节点体系结构可能与计算节点上的体系结构不同，这种情况经常发生。解决此问题的一种方法是，将配置和编译作为计算步骤，提交并将其部署到计算节点。